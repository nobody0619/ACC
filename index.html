<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çºªè€å¸ˆç²¾è‹±è®­ç»ƒç½‘ (æ‹–åŠ¨ç‰¹ä¾›ç‰ˆ)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* === æ ¸å¿ƒæ ·å¼ï¼šä»¿ V6 æ‹–åŠ¨ç‰ˆ UI === */
    :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --border: #cbd5e1; --accent: #3b82f6; }
    body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 900px; margin: auto; background-color: var(--bg); color: var(--text); padding: 20px; }

    /* å®¹å™¨ */
    #welcome, #chapters, #quiz, #finish { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; }
    #chapters, #quiz, #finish { display: none; }

    h1, h2 { color: #1e3a8a; text-align: center; }
    
    /* ç« èŠ‚åˆ—è¡¨æ ·å¼ */
    .group-title { font-weight: 800; font-size: 1.2em; margin: 20px 0 10px; color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; }
    .item { display: flex; justify-content: space-between; padding: 15px; background: white; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
    .item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

    /* === é¢˜ç›®åŒºåŸŸ (æ ¸å¿ƒæ”¹åŠ¨) === */
    .q-text { font-size: 1.4em; font-weight: bold; margin-bottom: 20px; line-height: 1.5; text-align: center; }
    .q-img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px auto; display: block; }

    /* å‘ä½åŒºåŸŸ (Slot) */
    .answer-area { 
        display: flex; justify-content: center; align-items: center; gap: 10px; 
        margin: 30px 0; padding: 20px; background: #f1f5f9; border-radius: 12px; 
    }
    .slot-label { font-weight: bold; color: #64748b; }
    
    /* é‚£ä¸ªâ€œå‘â€ */
    .slot { 
        border: 3px dashed #94a3b8; background: #fff; border-radius: 8px; 
        padding: 10px 20px; min-width: 150px; text-align: center; 
        cursor: pointer; color: #94a3b8; font-weight: bold; font-size: 1.1em;
        transition: 0.2s; user-select: none;
    }
    /* å¡«å…¥åçš„æ ·å­ */
    .slot.filled { 
        border-style: solid; border-color: var(--primary); 
        background: #eff6ff; color: var(--primary); 
    }
    /* æ¿€æ´»çŠ¶æ€ (å‡†å¤‡å¡«å…¥) */
    .slot.active { border-color: #f59e0b; background: #fffbeb; animation: pulse 1s infinite; }

    /* æ ‡ç­¾åº“ (Tags) */
    .tag-pool { margin-top: 30px; border-top: 2px solid #e2e8f0; padding-top: 20px; text-align: center; }
    .tag-label { font-size: 0.9em; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
    .tags { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    
    /* æ ‡ç­¾ä¸¸å­ */
    .tag { 
        background: white; border: 2px solid var(--border); padding: 10px 18px; border-radius: 25px; 
        cursor: pointer; font-size: 1em; font-weight: 600; color: #475569; transition: 0.2s; user-select: none;
    }
    .tag:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-3px); }
    .tag.selected { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

    /* æŒ‰é’® */
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.2s; }
    .btn-submit { background: var(--primary); color: white; }
    .btn-submit:hover { background: #1e40af; }
    .btn-next { background: #334155; color: white; display: none; }
    
    /* åé¦ˆ */
    #feedback { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; display: none; }
    .correct { background: #dcfce7; color: #166534; }
    .wrong { background: #fee2e2; color: #991b1b; }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
  </style>
</head>
<body>

  <div id="welcome">
    <h1>ğŸ“š è½½å…¥é¢˜åº“ä¸­...</h1>
  </div>

  <div id="chapters">
    <h1>ğŸ“‚ è¯¾ç¨‹ç›®å½•</h1>
    <div id="chapter-list"></div>
  </div>

  <div id="quiz">
    <button onclick="quitQuiz()" style="background:none; border:none; color:#64748b; cursor:pointer; font-weight:bold;">â† è¿”å›ç›®å½•</button>
    
    <div style="display:flex; justify-content:space-between; margin-top:10px; color:#94a3b8; font-size:0.9em;">
        <span id="q-progress">Question 1 / 10</span>
        <span id="q-score">Score: 0</span>
    </div>

    <div id="q-area">
        </div>

    <div id="feedback"></div>
    <button id="btn-action" class="btn btn-submit" onclick="checkAnswer()">æäº¤ç­”æ¡ˆ</button>
  </div>

  <div id="finish">
    <h1>ğŸ‰ ç»ƒä¹ å®Œæˆ!</h1>
    <div style="text-align:center; font-size:3em; font-weight:800; color:#2c3e50; margin:20px 0;">
        <span id="final-score">0</span><span style="font-size:0.5em">%</span>
    </div>
    <p style="text-align:center;">ç­”å¯¹: <b id="final-correct" style="color:green">0</b> | ç­”é”™: <b id="final-wrong" style="color:red">0</b></p>
    
    <div style="margin-top:30px; text-align:center;">
        <input type="text" id="student-name" placeholder="è¾“å…¥åå­—ä¸Šä¼ æˆç»©" style="padding:10px; width:60%; border:2px solid #e2e8f0; border-radius:8px;">
        <button class="btn btn-submit" style="margin-top:10px;" onclick="uploadScore()">ä¸Šä¼ æˆç»©</button>
        <div id="submit-status" style="margin-top:10px; color:#64748b; font-size:0.9em;"></div>
        <br><br>
        <button onclick="document.getElementById('finish').style.display='none'; document.getElementById('chapters').style.display='block';" style="background:none; border:none; color:#2563eb; cursor:pointer; text-decoration:underline;">è¿”å›ç« èŠ‚åˆ—è¡¨</button>
    </div>
  </div>

<script>
    // é…ç½®ï¼šä½ çš„ Google Script URL
    const SCRIPT_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; 

    // å…¨å±€å˜é‡
    let chapterData = [];
    let currentQuizQuestions = [];
    let currentQIndex = 0;
    let score = 0;
    let correctCount = 0;
    let wrongCount = 0;
    let currentChapterTitle = "";
    
    // æ‹–åŠ¨é€»è¾‘æ ¸å¿ƒå˜é‡
    let selectedTag = null; // å½“å‰é€‰ä¸­çš„æ ‡ç­¾å†…å®¹

    // åˆå§‹åŒ–
    window.onload = function() {
        Papa.parse("Chapters.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: h => h.trim(),
            complete: function(results) {
                chapterData = results.data;
                renderChapters();
                document.getElementById('welcome').style.display = 'none';
                document.getElementById('chapters').style.display = 'block';
            },
            error: function() { alert("é”™è¯¯ï¼šæ— æ³•è¯»å– Chapters.csvï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ã€‚"); }
        });
    };

    function renderChapters() {
        const list = document.getElementById('chapter-list');
        list.innerHTML = "";
        let lastGroup = "";
        
        chapterData.forEach(row => {
            if (!row.sheet) return;
            if (row.chapter !== lastGroup) {
                const div = document.createElement('div');
                div.className = 'group-title';
                div.innerText = row.chapter;
                list.appendChild(div);
                lastGroup = row.chapter;
            }
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `<span>${row.label}</span> <span>â¡</span>`;
            item.onclick = () => loadQuiz(row.sheet, row.label);
            list.appendChild(item);
        });
    }

    function loadQuiz(csvFile, title) {
        currentChapterTitle = title;
        Papa.parse(csvFile, {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: h => h.trim(),
            complete: function(results) {
                // è¿‡æ»¤æ‰æ²¡æœ‰é¢˜ç›®çš„è¡Œ
                currentQuizQuestions = results.data.filter(q => q.question && q.question.trim());
                if (currentQuizQuestions.length === 0) return alert("è¯¥ç« èŠ‚ä¸ºç©ºï¼");
                startQuiz();
            },
            error: function() { alert("æ‰¾ä¸åˆ°æ–‡ä»¶: " + csvFile); }
        });
    }

    function startQuiz() {
        currentQIndex = 0; score = 0; correctCount = 0; wrongCount = 0;
        document.getElementById('chapters').style.display = 'none';
        document.getElementById('finish').style.display = 'none';
        document.getElementById('quiz').style.display = 'block';
        renderQuestion();
    }

    // === æ ¸å¿ƒï¼šæ¸²æŸ“â€œæ‹–åŠ¨ç‰ˆâ€é¢˜ç›® ===
    function renderQuestion() {
        const q = currentQuizQuestions[currentQIndex];
        const area = document.getElementById('q-area');
        const feedback = document.getElementById('feedback');
        const actionBtn = document.getElementById('btn-action');

        // UI é‡ç½®
        document.getElementById('q-progress').innerText = `${currentQIndex + 1} / ${currentQuizQuestions.length}`;
        document.getElementById('q-score').innerText = `Score: ${score}`;
        feedback.style.display = 'none';
        actionBtn.innerText = "æäº¤ç­”æ¡ˆ";
        actionBtn.className = "btn btn-submit";
        actionBtn.onclick = checkAnswer;
        selectedTag = null; // é‡ç½®é€‰ä¸­çŠ¶æ€

        area.innerHTML = "";

        // 1. é¢˜ç›®æ–‡æœ¬
        let html = `<div class="q-text">${q.question}</div>`;
        
        // 2. å›¾ç‰‡ (å¦‚æœ‰)
        if (q.image && q.image.trim()) {
            html += `<img src="${q.image}" class="q-img">`;
        }

        // 3. ç”Ÿæˆâ€œå‘ä½â€ (Slot)
        // æ— è®º CSV å†™ input è¿˜æ˜¯ radioï¼Œæˆ‘ä»¬éƒ½ç”¨â€œå‘ä½â€æ¨¡å¼
        html += `
            <div class="answer-area">
                <span class="slot-label">ç­”æ¡ˆ:</span>
                <div class="slot" id="answer-slot" onclick="fillSlot(this)">ç‚¹å‡»ä¸‹æ–¹æ ‡ç­¾</div>
            </div>
        `;

        // 4. ç”Ÿæˆâ€œæ ‡ç­¾â€ (Tags) - ä» CSV çš„ A,B,C,D... åˆ—è¯»å–
        let tagsHtml = `<div class="tag-pool"><div class="tag-label">é€‰é¡¹åˆ—è¡¨</div><div class="tags">`;
        
        // æ”¶é›†æ‰€æœ‰éç©ºé€‰é¡¹
        let options = [];
        ['A','B','C','D','E','F','G'].forEach(key => {
            if (q[key] && q[key].trim()) {
                // æ¯”å¦‚ key="A", q[key]="Diabetes" -> Tag æ˜¾ç¤º "A. Diabetes"
                // æˆ–è€…æ˜¯çº¯æ–‡æœ¬ã€‚ä¸ºäº†åŒ¹é…ç­”æ¡ˆé€»è¾‘ï¼Œæˆ‘ä»¬éœ€æ³¨æ„ï¼š
                // å¦‚æœç­”æ¡ˆåˆ—å¡«çš„æ˜¯ "A"ï¼Œé‚£æˆ‘ä»¬è®© Tag çš„ value = "A"ã€‚
                // å¦‚æœç­”æ¡ˆåˆ—å¡«çš„æ˜¯ "Diabetes"ï¼Œé‚£ Tag value = "Diabetes"ã€‚
                
                // *é€šå¸¸ CSV æ ¼å¼æ˜¯ï¼šAnswer = Aã€‚æ‰€ä»¥ Tag åº”è¯¥æ˜¯ Aã€‚*
                // *ä¸ºäº†æ˜¾ç¤ºå¥½çœ‹ï¼Œæˆ‘ä»¬æ˜¾ç¤º "A. Diabetes"ï¼Œä½†å®é™…ä¼ é€’çš„å€¼æ˜¯ "A"ã€‚*
                
                options.push({ key: key, text: q[key] });
            }
        });

        // æ‰“ä¹±é€‰é¡¹ (å¯é€‰ï¼Œè¿™é‡Œå…ˆä¸æ‰“ä¹±ï¼ŒæŒ‰é¡ºåºæ’)
        // options.sort(() => Math.random() - 0.5); 

        options.forEach(opt => {
            // ç‚¹å‡»æ ‡ç­¾æ—¶ï¼Œé€‰ä¸­å®ƒ (value = key, e.g., "A")
            tagsHtml += `<div class="tag" onclick="selectTag(this, '${opt.key}')">${opt.key}. ${opt.text}</div>`;
        });

        tagsHtml += `</div></div>`;
        area.innerHTML = html + tagsHtml;
    }

    // === äº¤äº’é€»è¾‘ï¼šç‚¹å‡»æ ‡ç­¾ -> å¡«å……å‘ä½ ===
    function selectTag(el, val) {
        // 1. æ¸…é™¤å…¶ä»–æ ‡ç­¾çš„é«˜äº®
        document.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
        // 2. é«˜äº®å½“å‰æ ‡ç­¾
        el.classList.add('selected');
        // 3. è®°å½•å½“å‰é€‰ä¸­çš„å€¼ (ä¾‹å¦‚ "A")
        selectedTag = val;
        
        // 4. ä¸ºäº†æ–¹ä¾¿ï¼Œç‚¹å‡»æ ‡ç­¾ç›´æ¥è®©å‘ä½â€œè·³åŠ¨â€æç¤ºç”¨æˆ·å¯ä»¥å¡«äº†
        const slot = document.getElementById('answer-slot');
        slot.classList.add('active');
        
        // *ä½ çš„éœ€æ±‚ï¼šç‚¹å‡»æ ‡ç­¾ç›´æ¥å¡«è¿›å»ï¼Œè¿˜æ˜¯å…ˆé€‰æ ‡ç­¾å†ç‚¹å‘ï¼Ÿ*
        // *æœ€é¡ºæ‰‹çš„æ–¹å¼ï¼šç‚¹å‡»æ ‡ç­¾ -> è‡ªåŠ¨å¡«å…¥å‘ä½ã€‚*
        fillSlot(slot, val); 
    }

    function fillSlot(slot, valOverride) {
        const val = valOverride || selectedTag;
        if (!val) return; // æ²¡é€‰æ ‡ç­¾

        // å¡«å…¥å‘ä½
        slot.innerText = val; // æ˜¾ç¤º "A"
        slot.classList.add('filled');
        slot.classList.remove('active');
        slot.dataset.value = val; // å­˜èµ·æ¥ç”¨äºåˆ¤åˆ†
    }

    // === åˆ¤åˆ†é€»è¾‘ ===
    function checkAnswer() {
        const slot = document.getElementById('answer-slot');
        const userVal = slot.dataset.value; // è·å–å¡«å…¥çš„å€¼ (e.g. "A")
        
        if (!userVal) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ ‡ç­¾å¡«å…¥ç­”æ¡ˆï¼");

        const q = currentQuizQuestions[currentQIndex];
        const correctVal = normalizeString(q.answer); // CSV é‡Œçš„ answer (e.g. "A")
        const cleanUser = normalizeString(userVal);

        const feedback = document.getElementById('feedback');
        const btn = document.getElementById('btn-action');

        feedback.style.display = 'block';

        if (cleanUser === correctVal) {
            feedback.className = "correct";
            feedback.innerHTML = "âœ… ç­”å¯¹äº†ï¼";
            score += 10; correctCount++;
        } else {
            feedback.className = "wrong";
            feedback.innerHTML = `âŒ ç­”é”™äº†ã€‚<br>ä½ çš„ç­”æ¡ˆ: ${userVal} <br>æ­£ç¡®ç­”æ¡ˆ: ${q.answer}`;
            wrongCount++;
        }

        // æŒ‰é’®å˜â€œä¸‹ä¸€é¢˜â€
        btn.innerText = "ä¸‹ä¸€é¢˜ â¡";
        btn.className = "btn btn-next";
        btn.style.display = "block"; // ç¡®ä¿æ˜¾ç¤º
        btn.onclick = nextQuestion;
        
        // ç¦ç”¨æ ‡ç­¾ç‚¹å‡»
        document.querySelectorAll('.tag').forEach(t => t.style.pointerEvents = 'none');
    }

    function normalizeString(str) {
        if (!str) return "";
        return String(str).trim().toUpperCase();
    }

    function nextQuestion() {
        currentQIndex++;
        if (currentQIndex < currentQuizQuestions.length) {
            renderQuestion();
        } else {
            finishQuiz();
        }
    }

    function quitQuiz() {
        document.getElementById('quiz').style.display = 'none';
        document.getElementById('chapters').style.display = 'block';
    }

    function finishQuiz() {
        document.getElementById('quiz').style.display = 'none';
        document.getElementById('finish').style.display = 'block';
        const total = currentQuizQuestions.length;
        const finalPercent = Math.round((correctCount / total) * 100);
        document.getElementById('final-score').innerText = finalPercent;
        document.getElementById('final-correct').innerText = correctCount;
        document.getElementById('final-wrong').innerText = wrongCount;
    }

    // ä¸Šä¼ æˆç»© (ä¿æŒä¸å˜)
    function uploadScore() {
        const name = document.getElementById('student-name').value.trim();
        if(!name) return alert("è¯·è¾“å…¥åå­—");
        
        document.getElementById('submit-status').innerText = "â³ æ­£åœ¨ä¸Šä¼ ...";
        
        const img = new Image();
        img.src = `${SCRIPT_URL}?book=F4ACC&name=${encodeURIComponent(name)}&score=${document.getElementById('final-score').innerText}&quizId=${encodeURIComponent(currentChapterTitle)}`;
        
        setTimeout(() => {
            document.getElementById('submit-status').innerText = "âœ… æˆç»©å·²æäº¤ (å‡è®¾)";
        }, 1000);
    }
</script>

</body>
</html>
