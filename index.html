<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çºªè€å¸ˆ F4 ACC ç²¾è‹±è®­ç»ƒç½‘ (å‡çº§ç‰ˆ)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* --- æ ·å¼ä¿æŒåŸæ±åŸå‘³ï¼Œå¢åŠ äº†è¾“å…¥æ¡†çš„æ ·å¼ --- */
    body { font-family: 'Segoe UI', Arial, sans-serif; max-width:900px; margin:auto; background-color: #f4f4f9; color: #333; }
    
    /* å®¹å™¨æ ·å¼ */
    #welcome, #chapters, #quiz, #finish { margin: 20px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    #chapters, #quiz, #finish { display: none; }

    h1, h2 { color: #2c3e50; }
    button { cursor: pointer; transition: 0.2s; }

    /* æ‚¬æµ®è¿”å›æŒ‰é’® */
    .floating-back { position: sticky; top:10px; left:0; text-align:left; z-index:5; margin-bottom: 10px; }
    .floating-back button {
      padding: 8px 16px; border-radius: 20px; border: none; background: #34495e; color: #fff; 
      font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .floating-back button:hover { background: #2c3e50; transform: translateY(-2px); }

    /* ç« èŠ‚åˆ—è¡¨ */
    .group { text-align:left; margin:15px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .group-title { font-weight:bold; font-size:18px; margin:8px 0; color: #2980b9; }
    .item {
      display:flex; justify-content:space-between; align-items:center; 
      padding:12px; border-radius:8px; background:#f8f9fa; margin-bottom:8px; cursor:pointer; border: 1px solid #eee;
    }
    .item:hover { background:#e8f4fd; border-color: #3498db; }
    .badge { font-size:12px; background:#3498db; color:#fff; padding:2px 8px; border-radius:4px; margin-right: 8px; }

    /* é¢˜ç›®åŒºåŸŸ */
    .q-card { text-align: center; }
    .q-text { font-size: 1.3em; font-weight: bold; margin: 20px 0; }
    .q-img { max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; }

    /* é€‰é¡¹æŒ‰é’® (é€‰æ‹©é¢˜) */
    .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 20px; }
    .opt-btn {
      padding: 15px; border: 2px solid #e0e0e0; background: white; border-radius: 10px;
      font-size: 16px; text-align: left;
    }
    .opt-btn:hover { border-color: #3498db; background: #f0f8ff; }
    .opt-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
    .opt-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }

    /* --- æ–°å¢ï¼šå¡«ç©ºé¢˜æ ·å¼ --- */
    .input-area { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .input-field {
        padding: 12px; font-size: 18px; width: 80%; border: 2px solid #ccc; border-radius: 8px; text-align: center; outline: none;
    }
    .input-field:focus { border-color: #3498db; }
    .submit-input-btn {
        padding: 10px 30px; background-color: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
    }
    .submit-input-btn:hover { background-color: #2980b9; }

    /* åé¦ˆåŒºåŸŸ */
    #feedback { margin-top: 20px; font-weight: bold; font-size: 1.1em; min-height: 30px; }
    .feedback-correct { color: #28a745; }
    .feedback-wrong { color: #dc3545; }

    /* ç»“ç®—é¡µ */
    .score-box { font-size: 2em; font-weight: bold; color: #2c3e50; margin: 20px 0; }
    .form-group { margin: 15px 0; }
    input[type="text"] { padding: 10px; width: 60%; border: 1px solid #ccc; border-radius: 4px; }
    .primary-btn { padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; font-size: 16px; }
  </style>
</head>
<body>

  <div id="welcome">
    <h1>ğŸ“ çºªè€å¸ˆ F4 ACC ç²¾è‹±è®­ç»ƒç½‘</h1>
    <p>Loading data...</p>
  </div>

  <div id="chapters">
    <h2>ğŸ“‚ é€‰æ‹©ç»ƒä¹ ç« èŠ‚</h2>
    <div id="chapter-list"></div>
  </div>

  <div id="quiz">
    <div class="floating-back">
      <button onclick="quitQuiz()">Quit / è¿”å›ç›®å½•</button>
    </div>
    
    <div class="q-card">
        <div style="display:flex; justify-content:space-between; color:#7f8c8d; font-size:0.9em;">
            <span id="q-progress">1 / 10</span>
            <span id="q-score">Score: 0</span>
        </div>
        
        <div id="q-content">
            </div>

        <div id="feedback"></div>

        <button id="next-btn" class="primary-btn" style="display:none; margin-top:20px;" onclick="nextQuestion()">ä¸‹ä¸€é¢˜ â¡</button>
    </div>
  </div>

  <div id="finish">
    <h2>ğŸ‰ ç»ƒä¹ ç»“æŸ</h2>
    <div class="score-box">å¾—åˆ†: <span id="final-score">0</span>%</div>
    <p>ç­”å¯¹: <span id="final-correct">0</span> | ç­”é”™: <span id="final-wrong">0</span> | ç”¨æ—¶: <span id="final-time">0</span>ç§’</p>
    
    <div class="form-group">
        <input type="text" id="student-name" placeholder="è¯·è¾“å…¥ä½ çš„åå­— (ç”¨äºä¸Šä¼ æˆç»©)" />
    </div>
    <button class="primary-btn" onclick="uploadScore()">ä¸Šä¼ æˆç»©</button>
    <div id="submit-status" style="margin-top:10px; font-size:0.9em; color:#666;"></div>
    
    <div id="controls" style="margin-top:30px;"></div>
    
    <iframe name="hidden_iframe" style="display:none;"></iframe>
    <form id="postForm" action="YOUR_GOOGLE_SCRIPT_URL" method="post" target="hidden_iframe" style="display:none;">
        <input type="text" name="book" />
        <input type="text" name="quizId" />
        <input type="text" name="name" />
        <input type="text" name="score" />
        <input type="text" name="correct" />
        <input type="text" name="wrong" />
        <input type="text" name="time" />
    </form>
  </div>

<script>
    // === é…ç½®åŒºåŸŸ ===
    // ä½ çš„ Google Script URL (è¯·æ›¿æ¢æˆä½ è‡ªå·±çš„)
    const SCRIPT_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; 
    
    // === å…¨å±€å˜é‡ ===
    let chapterData = [];
    let currentQuizQuestions = [];
    let currentQIndex = 0;
    let score = 0;
    let correctCount = 0;
    let wrongCount = 0;
    let startTime = 0;
    let currentChapterTitle = "";

    // === åˆå§‹åŒ–ï¼šåŠ è½½ç« èŠ‚åˆ—è¡¨ ===
    window.onload = function() {
        Papa.parse("Chapters.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                chapterData = results.data;
                renderChapters();
                document.getElementById('welcome').style.display = 'none';
                document.getElementById('chapters').style.display = 'block';
            },
            error: function(err) {
                alert("æ— æ³•åŠ è½½ Chapters.csvï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸Šä¼ ã€‚");
            }
        });
    };

    // æ¸²æŸ“ç« èŠ‚åˆ—è¡¨
    function renderChapters() {
        const list = document.getElementById('chapter-list');
        list.innerHTML = "";
        
        // åˆ†ç»„é€»è¾‘ (æ ¹æ® csv ä¸­çš„ chapter åˆ—)
        let lastGroup = "";
        
        chapterData.forEach((row, index) => {
            if (!row.sheet) return; // è·³è¿‡æ— æ•ˆè¡Œ

            // å¦‚æœæ˜¯æ–°ç»„ï¼ŒåŠ æ ‡é¢˜
            if (row.chapter !== lastGroup) {
                const groupTitle = document.createElement('div');
                groupTitle.className = 'group-title';
                groupTitle.innerText = row.chapter;
                list.appendChild(groupTitle);
                lastGroup = row.chapter;
            }

            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `<span>${row.label}</span> <span style="color:#aaa;">></span>`;
            item.onclick = () => loadQuiz(row.sheet, row.label);
            list.appendChild(item);
        });
    }

    // åŠ è½½å…·ä½“ CSV é¢˜ç›®
    function loadQuiz(csvFile, title) {
        currentChapterTitle = title;
        Papa.parse(csvFile, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                // è¿‡æ»¤æ‰ç©ºè¡Œæˆ–æ— é—®é¢˜è¡Œ
                currentQuizQuestions = results.data.filter(q => q.question);
                if (currentQuizQuestions.length === 0) {
                    alert("è¯¥ç« èŠ‚æ²¡æœ‰é¢˜ç›®ï¼");
                    return;
                }
                startQuiz();
            },
            error: function() {
                alert("æ‰¾ä¸åˆ°æ–‡ä»¶: " + csvFile);
            }
        });
    }

    // === æ ¸å¿ƒï¼šå¼€å§‹æµ‹éªŒ ===
    function startQuiz() {
        currentQIndex = 0;
        score = 0;
        correctCount = 0;
        wrongCount = 0;
        startTime = Date.now();

        document.getElementById('chapters').style.display = 'none';
        document.getElementById('finish').style.display = 'none';
        document.getElementById('quiz').style.display = 'block';

        renderQuestion();
    }

    // æ¸²æŸ“å•é¢˜ (æ”¯æŒ radio å’Œ input)
    function renderQuestion() {
        const q = currentQuizQuestions[currentQIndex];
        const contentDiv = document.getElementById('q-content');
        const feedbackDiv = document.getElementById('feedback');
        const nextBtn = document.getElementById('next-btn');

        // æ›´æ–°è¿›åº¦æ¡
        document.getElementById('q-progress').innerText = `${currentQIndex + 1} / ${currentQuizQuestions.length}`;
        document.getElementById('q-score').innerText = `Score: ${score}`; // æ˜¾ç¤ºå½“å‰åˆ†æ•°ï¼ˆå¯é€‰ï¼‰
        
        // é‡ç½®ç•Œé¢
        contentDiv.innerHTML = "";
        feedbackDiv.innerHTML = "";
        feedbackDiv.className = "";
        nextBtn.style.display = "none";

        // 1. æ˜¾ç¤ºé¢˜ç›®æ–‡æœ¬
        const qText = document.createElement('div');
        qText.className = 'q-text';
        qText.innerHTML = q.question; // å…è®¸ HTMLï¼Œæ¯”å¦‚æ¢è¡Œ
        contentDiv.appendChild(qText);

        // 2. æ˜¾ç¤ºå›¾ç‰‡ (å¦‚æœæœ‰)
        if (q.image && q.image.trim() !== "") {
            const img = document.createElement('img');
            img.src = q.image; 
            img.className = 'q-img';
            contentDiv.appendChild(img);
        }

        // 3. åˆ¤æ–­é¢˜å‹å¹¶æ¸²æŸ“
        // å¦‚æœ type æ˜¯ 'input'ï¼Œæ¸²æŸ“è¾“å…¥æ¡†ï¼›å¦åˆ™é»˜è®¤æ¸²æŸ“é€‰æ‹©é¢˜
        if (q.type && q.type.trim().toLowerCase() === 'input') {
            renderInputInterface(q, contentDiv);
        } else {
            renderChoiceInterface(q, contentDiv);
        }
    }

    // --- æ¸²æŸ“é€‰æ‹©é¢˜ (Radio) ---
    function renderChoiceInterface(q, container) {
        const grid = document.createElement('div');
        grid.className = 'options-grid';
        
        ['A', 'B', 'C', 'D', 'E'].forEach(opt => {
            if (q[opt]) { // å¦‚æœæœ‰è¿™ä¸ªé€‰é¡¹
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = `${opt}. ${q[opt]}`;
                btn.onclick = () => checkChoiceAnswer(opt, q.answer, btn, grid);
                grid.appendChild(btn);
            }
        });
        container.appendChild(grid);
    }

    // --- æ¸²æŸ“å¡«ç©ºé¢˜ (Input) ---
    function renderInputInterface(q, container) {
        const wrapper = document.createElement('div');
        wrapper.className = 'input-area';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'input-field';
        input.placeholder = 'è¾“å…¥ç­”æ¡ˆ...';
        input.id = 'user-input';
        
        // æ”¯æŒæŒ‰ Enter æäº¤
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                checkInputAnswer(q.answer);
            }
        });

        const btn = document.createElement('button');
        btn.className = 'submit-input-btn';
        btn.innerText = 'æäº¤ç­”æ¡ˆ';
        btn.onclick = () => checkInputAnswer(q.answer);

        wrapper.appendChild(input);
        wrapper.appendChild(btn);
        container.appendChild(wrapper);
        
        // è‡ªåŠ¨èšç„¦
        setTimeout(() => input.focus(), 100);
    }

    // === åˆ¤åˆ†é€»è¾‘ï¼šé€‰æ‹©é¢˜ ===
    function checkChoiceAnswer(selected, correct, btnElement, gridElement) {
        // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
        const allBtns = gridElement.querySelectorAll('button');
        allBtns.forEach(b => b.disabled = true);

        const feedback = document.getElementById('feedback');
        const nextBtn = document.getElementById('next-btn');

        if (selected.trim().toUpperCase() === correct.trim().toUpperCase()) {
            // ç­”å¯¹
            btnElement.classList.add('correct');
            feedback.innerText = "âœ… ç­”å¯¹äº†ï¼";
            feedback.className = "feedback-correct";
            score += 10; // å‡è®¾æ¯é¢˜ 10 åˆ†
            correctCount++;
        } else {
            // ç­”é”™
            btnElement.classList.add('wrong');
            // æ‰¾å‡ºæ­£ç¡®ç­”æ¡ˆå¹¶æ ‡ç»¿
            allBtns.forEach(b => {
                if (b.innerText.startsWith(correct.trim().toUpperCase() + ".")) {
                    b.classList.add('correct');
                }
            });
            feedback.innerText = `âŒ ç­”é”™äº†ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯ ${correct}`;
            feedback.className = "feedback-wrong";
            wrongCount++;
        }
        nextBtn.style.display = "inline-block";
    }

    // === åˆ¤åˆ†é€»è¾‘ï¼šå¡«ç©ºé¢˜ ===
    function checkInputAnswer(correctAnswer) {
        const input = document.getElementById('user-input');
        const submitBtn = document.querySelector('.submit-input-btn');
        const feedback = document.getElementById('feedback');
        const nextBtn = document.getElementById('next-btn');

        // ç¦ç”¨è¾“å…¥
        input.disabled = true;
        submitBtn.disabled = true;

        const userVal = input.value.trim();
        
        // æ ¸å¿ƒï¼šæ¨¡ç³ŠåŒ¹é…é€»è¾‘ (å»é™¤ RM, é€—å·, ç©ºæ ¼, å¤§å°å†™)
        // ä¾‹å­: ç­”æ¡ˆ "1200", ç”¨æˆ·è¾“å…¥ "RM 1,200" -> ç³»ç»Ÿè§†ä¸º "1200"
        const cleanUser = normalizeString(userVal);
        const cleanAns = normalizeString(correctAnswer);

        if (cleanUser === cleanAns && cleanUser !== "") {
            feedback.innerText = "âœ… ç­”å¯¹äº†ï¼";
            feedback.className = "feedback-correct";
            score += 10;
            correctCount++;
        } else {
            feedback.innerText = `âŒ ç­”é”™äº†ã€‚å‚è€ƒç­”æ¡ˆ: ${correctAnswer}`;
            feedback.className = "feedback-wrong";
            wrongCount++;
        }
        nextBtn.style.display = "inline-block";
    }

    // å­—ç¬¦ä¸²æ¸…æ´—å·¥å…·
    function normalizeString(str) {
        if (!str) return "";
        return str.toString()
            .toLowerCase() // è½¬å°å†™
            .replace(/rm/g, "") // å»æ‰ RM
            .replace(/,/g, "") // å»æ‰é€—å·
            .replace(/\s+/g, ""); // å»æ‰æ‰€æœ‰ç©ºæ ¼
    }

    // === ä¸‹ä¸€é¢˜ & ç»“æŸ ===
    function nextQuestion() {
        currentQIndex++;
        if (currentQIndex < currentQuizQuestions.length) {
            renderQuestion();
        } else {
            finishQuiz();
        }
    }

    function quitQuiz() {
        if(confirm("ç¡®å®šè¦é€€å‡ºç»ƒä¹ å—ï¼Ÿè¿›åº¦å°†ä¸¢å¤±ã€‚")) {
            document.getElementById('quiz').style.display = 'none';
            document.getElementById('chapters').style.display = 'block';
        }
    }

    function finishQuiz() {
        document.getElementById('quiz').style.display = 'none';
        document.getElementById('finish').style.display = 'block';

        // è®¡ç®—æœ€ç»ˆç™¾åˆ†æ¯”
        const total = currentQuizQuestions.length;
        const finalPercent = Math.round((correctCount / total) * 100);
        const timeSpent = Math.floor((Date.now() - startTime) / 1000);

        document.getElementById('final-score').innerText = finalPercent;
        document.getElementById('final-correct').innerText = correctCount;
        document.getElementById('final-wrong').innerText = wrongCount;
        document.getElementById('final-time').innerText = timeSpent;
        
        // æ¸²æŸ“è¿”å›æŒ‰é’®
        const ctrl = document.getElementById('controls');
        ctrl.innerHTML = '';
        const backBtn = document.createElement('button');
        backBtn.className = 'primary-btn';
        backBtn.innerText = 'è¿”å›ç›®å½•';
        backBtn.onclick = () => {
            document.getElementById('finish').style.display = 'none';
            document.getElementById('chapters').style.display = 'block';
        };
        ctrl.appendChild(backBtn);
    }

    // === ä¸Šä¼ æˆç»© (åŸæœ‰é€»è¾‘) ===
    async function uploadScore() {
        const name = document.getElementById('student-name').value.trim();
        if(!name) return alert("è¯·å…ˆè¾“å…¥åå­—ï¼");

        const statusDiv = document.getElementById('submit-status');
        statusDiv.innerText = "â³ æ­£åœ¨ä¸Šä¼ ...";

        const total = currentQuizQuestions.length;
        const finalPercent = Math.round((correctCount / total) * 100);
        const timeSpent = Math.floor((Date.now() - startTime) / 1000);

        const payload = {
            book: "F4 ACC", // æˆ–è€…ä» CSV è¯»å–
            quizId: currentChapterTitle,
            name: name,
            score: finalPercent,
            correct: correctCount,
            wrong: wrongCount,
            time: timeSpent
        };

        try {
            // å°è¯• fetch (æ›´ç°ä»£çš„æ–¹æ³•)
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams(payload)
            });
            // Google Script è·¨åŸŸé€šå¸¸ä¸è¿”å› JSONï¼Œå¯èƒ½ä¼šæŠ¥é”™ä½†å®é™…æˆåŠŸ
            // å¦‚æœä¸æƒ³å¤„ç† CORS é”™è¯¯ï¼Œå¯ä»¥ç›´æ¥ç”¨ hidden iframe æ–¹æ³•
            statusDiv.innerText = "âœ… æˆç»©å·²æäº¤ (Fetch)";
        } catch (e) {
            // å¦‚æœ fetch å¤±è´¥ (é€šå¸¸æ˜¯ CORS é—®é¢˜)ï¼Œç”¨ iframe å…œåº•
            const form = document.getElementById('postForm');
            form.book.value = payload.book;
            form.quizId.value = payload.quizId;
            form.name.value = payload.name;
            form.score.value = payload.score;
            form.correct.value = payload.correct;
            form.wrong.value = payload.wrong;
            form.time.value = payload.time;
            form.submit();
            statusDiv.innerText = "âœ… æˆç»©å·²é€šè¿‡å¤‡ç”¨é€šé“æäº¤";
        }
    }
</script>

</body>
</html>
