<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çºªè€å¸ˆ F4 ACC ç²¾è‹±è®­ç»ƒç½‘ (ä¿®å¤ç‰ˆ)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; max-width:900px; margin:auto; background-color: #f4f4f9; color: #333; }
    
    #welcome, #chapters, #quiz, #finish { margin: 20px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    #chapters, #quiz, #finish { display: none; }

    h1, h2 { color: #2c3e50; }
    button { cursor: pointer; transition: 0.2s; }

    /* æ‚¬æµ®è¿”å›æŒ‰é’® */
    .floating-back { position: sticky; top:10px; left:0; text-align:left; z-index:5; margin-bottom: 10px; }
    .floating-back button {
      padding: 8px 16px; border-radius: 20px; border: none; background: #34495e; color: #fff; 
      font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .floating-back button:hover { background: #2c3e50; transform: translateY(-2px); }

    /* ç« èŠ‚åˆ—è¡¨ */
    .group { text-align:left; margin:15px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .group-title { font-weight:bold; font-size:18px; margin:8px 0; color: #2980b9; }
    .item {
      display:flex; justify-content:space-between; align-items:center; 
      padding:12px; border-radius:8px; background:#f8f9fa; margin-bottom:8px; cursor:pointer; border: 1px solid #eee;
    }
    .item:hover { background:#e8f4fd; border-color: #3498db; }

    /* é¢˜ç›®åŒºåŸŸ */
    .q-card { text-align: center; }
    .q-text { font-size: 1.3em; font-weight: bold; margin: 20px 0; }
    .q-img { max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; }

    /* é€‰é¡¹åˆ—è¡¨ (ç”¨äºå¡«ç©ºé¢˜å±•ç¤ºå‚è€ƒ) */
    .options-list { text-align: left; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; display: inline-block; width: 90%; }
    .opt-item { margin: 8px 0; font-size: 1.1em; }
    .opt-key { font-weight: bold; color: #2980b9; margin-right: 8px; }

    /* é€‰æ‹©é¢˜æŒ‰é’® */
    .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 20px; }
    .opt-btn { padding: 15px; border: 2px solid #e0e0e0; background: white; border-radius: 10px; font-size: 16px; text-align: left; }
    .opt-btn:hover { border-color: #3498db; background: #f0f8ff; }
    .opt-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
    .opt-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }

    /* å¡«ç©ºé¢˜è¾“å…¥ */
    .input-area { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .input-field { padding: 12px; font-size: 18px; width: 60%; border: 2px solid #ccc; border-radius: 8px; text-align: center; outline: none; }
    .input-field:focus { border-color: #3498db; }
    .submit-input-btn { padding: 10px 30px; background-color: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; }

    /* åé¦ˆ */
    #feedback { margin-top: 20px; font-weight: bold; font-size: 1.1em; min-height: 30px; white-space: pre-wrap; }
    .feedback-correct { color: #28a745; }
    .feedback-wrong { color: #dc3545; }

    /* ç»“ç®— */
    .score-box { font-size: 2em; font-weight: bold; color: #2c3e50; margin: 20px 0; }
    .primary-btn { padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; font-size: 16px; }
  </style>
</head>
<body>

  <div id="welcome">
    <h1>ğŸ“ çºªè€å¸ˆ F4 ACC ç²¾è‹±è®­ç»ƒç½‘ (ä¿®å¤ç‰ˆ)</h1>
    <p>æ­£åœ¨è¯»å–æ•°æ®ï¼Œè¯·ç¨å€™...</p>
  </div>

  <div id="chapters">
    <h2>ğŸ“‚ é€‰æ‹©ç»ƒä¹ ç« èŠ‚</h2>
    <div id="chapter-list"></div>
  </div>

  <div id="quiz">
    <div class="floating-back">
      <button onclick="quitQuiz()">Quit / è¿”å›ç›®å½•</button>
    </div>
    
    <div class="q-card">
        <div style="display:flex; justify-content:space-between; color:#7f8c8d; font-size:0.9em;">
            <span id="q-progress">1 / 10</span>
            <span id="q-score">Score: 0</span>
        </div>
        
        <div id="q-content"></div>
        <div id="feedback"></div>
        <button id="next-btn" class="primary-btn" style="display:none; margin-top:20px;" onclick="nextQuestion()">ä¸‹ä¸€é¢˜ â¡</button>
    </div>
  </div>

  <div id="finish">
    <h2>ğŸ‰ ç»ƒä¹ ç»“æŸ</h2>
    <div class="score-box">å¾—åˆ†: <span id="final-score">0</span>%</div>
    <p>ç­”å¯¹: <span id="final-correct">0</span> | ç­”é”™: <span id="final-wrong">0</span></p>
    
    <input type="text" id="student-name" placeholder="è¾“å…¥åå­— (ç”¨äºä¸Šä¼ )" style="padding:10px; width:60%; margin:15px 0; border:1px solid #ccc; border-radius:4px;">
    <button class="primary-btn" onclick="uploadScore()">ä¸Šä¼ æˆç»©</button>
    <div id="submit-status" style="margin-top:10px; color:#666;"></div>
    
    <div style="margin-top:30px;">
        <button class="primary-btn" onclick="document.getElementById('finish').style.display='none'; document.getElementById('chapters').style.display='block';">è¿”å›ç›®å½•</button>
    </div>
  </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // è¯·æ›¿æ¢ä½ çš„ URL
    
    let chapterData = [];
    let currentQuizQuestions = [];
    let currentQIndex = 0;
    let score = 0;
    let correctCount = 0;
    let wrongCount = 0;
    let currentChapterTitle = "";

    window.onload = function() {
        Papa.parse("Chapters.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: h => h.trim(), // ä¿®å¤ï¼šè‡ªåŠ¨å»é™¤è¡¨å¤´ç©ºæ ¼
            complete: function(results) {
                chapterData = results.data;
                renderChapters();
                document.getElementById('welcome').style.display = 'none';
                document.getElementById('chapters').style.display = 'block';
            },
            error: function() { alert("æ— æ³•åŠ è½½ Chapters.csv"); }
        });
    };

    function renderChapters() {
        const list = document.getElementById('chapter-list');
        list.innerHTML = "";
        let lastGroup = "";
        
        chapterData.forEach(row => {
            if (!row.sheet) return;
            if (row.chapter !== lastGroup) {
                const div = document.createElement('div');
                div.className = 'group-title';
                div.innerText = row.chapter;
                list.appendChild(div);
                lastGroup = row.chapter;
            }
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `<span>${row.label}</span> <span>></span>`;
            item.onclick = () => loadQuiz(row.sheet, row.label);
            list.appendChild(item);
        });
    }

    function loadQuiz(csvFile, title) {
        currentChapterTitle = title;
        Papa.parse(csvFile, {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: h => h.trim(), // å…³é”®ä¿®å¤ï¼šå»é™¤è¡¨å¤´ç©ºæ ¼é˜²æ­¢è¯»å–å¤±è´¥
            complete: function(results) {
                currentQuizQuestions = results.data.filter(q => q.question && q.question.trim());
                if (currentQuizQuestions.length === 0) return alert("è¯¥ç« èŠ‚æ²¡æœ‰é¢˜ç›®æˆ–æ ¼å¼é”™è¯¯ï¼");
                startQuiz();
            },
            error: function() { alert("æ‰¾ä¸åˆ°æ–‡ä»¶: " + csvFile); }
        });
    }

    function startQuiz() {
        currentQIndex = 0;
        score = 0;
        correctCount = 0;
        wrongCount = 0;
        document.getElementById('chapters').style.display = 'none';
        document.getElementById('finish').style.display = 'none';
        document.getElementById('quiz').style.display = 'block';
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentQuizQuestions[currentQIndex];
        const contentDiv = document.getElementById('q-content');
        const feedbackDiv = document.getElementById('feedback');
        const nextBtn = document.getElementById('next-btn');

        document.getElementById('q-progress').innerText = `${currentQIndex + 1} / ${currentQuizQuestions.length}`;
        document.getElementById('q-score').innerText = `Score: ${score}`;
        
        contentDiv.innerHTML = "";
        feedbackDiv.innerHTML = "";
        feedbackDiv.className = "";
        nextBtn.style.display = "none";

        // é¢˜ç›®
        const qText = document.createElement('div');
        qText.className = 'q-text';
        qText.innerHTML = q.question;
        contentDiv.appendChild(qText);

        // å›¾ç‰‡
        if (q.image && q.image.trim()) {
            const img = document.createElement('img');
            img.src = q.image; img.className = 'q-img';
            contentDiv.appendChild(img);
        }

        const type = (q.type || "").trim().toLowerCase();

        // æ™ºèƒ½ä¿®å¤ï¼šå¦‚æœæ˜¯ input ç±»å‹ï¼Œä½†ä¹Ÿæ£€æµ‹åˆ°äº† A/B/C é€‰é¡¹ï¼Œå…ˆå±•ç¤ºé€‰é¡¹è¡¨
        if (type === 'input') {
            const options = ['A','B','C','D','E','F','G','H'];
            let hasOptions = false;
            let optionsHtml = `<div class="options-list">`;
            
            options.forEach(key => {
                if (q[key] && q[key].trim()) {
                    hasOptions = true;
                    optionsHtml += `<div class="opt-item"><span class="opt-key">${key}</span> ${q[key]}</div>`;
                }
            });
            optionsHtml += `</div>`;
            
            if (hasOptions) contentDiv.innerHTML += optionsHtml; // æ’å…¥é€‰é¡¹æ˜¾ç¤º
            renderInputInterface(q, contentDiv);
        } else {
            renderChoiceInterface(q, contentDiv);
        }
    }

    function renderChoiceInterface(q, container) {
        const grid = document.createElement('div');
        grid.className = 'options-grid';
        ['A','B','C','D','E'].forEach(opt => {
            if (q[opt]) {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = `${opt}. ${q[opt]}`;
                btn.onclick = () => checkChoiceAnswer(opt, q.answer, btn, grid);
                grid.appendChild(btn);
            }
        });
        container.appendChild(grid);
    }

    function renderInputInterface(q, container) {
        const wrapper = document.createElement('div');
        wrapper.className = 'input-area';
        
        const input = document.createElement('input');
        input.className = 'input-field';
        input.placeholder = 'åœ¨æ­¤è¾“å…¥ç­”æ¡ˆ...';
        input.id = 'user-input';
        
        // å…è®¸å›è½¦æäº¤
        input.addEventListener("keypress", function(e) {
            if (e.key === "Enter") checkInputAnswer(q.answer);
        });

        const btn = document.createElement('button');
        btn.className = 'submit-input-btn';
        btn.innerText = 'æäº¤';
        btn.onclick = () => checkInputAnswer(q.answer);

        wrapper.appendChild(input);
        wrapper.appendChild(btn);
        container.appendChild(wrapper);
        setTimeout(() => input.focus(), 100);
    }

    function checkChoiceAnswer(selected, correct, btn, grid) {
        const allBtns = grid.querySelectorAll('button');
        allBtns.forEach(b => b.disabled = true);
        const feedback = document.getElementById('feedback');
        
        // å¼ºåŠ›æ¸…æ´—ç­”æ¡ˆ
        const cleanCorrect = normalizeString(correct);
        const cleanSelected = normalizeString(selected);

        if (cleanSelected === cleanCorrect) {
            btn.classList.add('correct');
            feedback.innerHTML = "âœ… ç­”å¯¹äº†ï¼";
            feedback.className = "feedback-correct";
            score += 10; correctCount++;
        } else {
            btn.classList.add('wrong');
            // å°è¯•æ ‡å‡ºæ­£ç¡®é€‰é¡¹
            allBtns.forEach(b => {
                if (normalizeString(b.innerText.charAt(0)) === cleanCorrect) {
                    b.classList.add('correct');
                }
            });
            feedback.innerHTML = `âŒ ç­”é”™äº†ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯ ${correct}`;
            feedback.className = "feedback-wrong";
            wrongCount++;
        }
        document.getElementById('next-btn').style.display = "inline-block";
    }

    function checkInputAnswer(correctAnswer) {
        const input = document.getElementById('user-input');
        const submitBtn = document.querySelector('.submit-input-btn');
        input.disabled = true; submitBtn.disabled = true;
        
        const feedback = document.getElementById('feedback');
        
        // æ ¸å¿ƒä¿®å¤ï¼šå¼ºåŠ›å¯¹æ¯”
        const cleanUser = normalizeString(input.value);
        const cleanAns = normalizeString(correctAnswer);

        // Debug: å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œå¯ä»¥åœ¨ F12 æ§åˆ¶å°çœ‹åˆ°å¯¹æ¯”
        console.log(`User: "${cleanUser}" vs Ans: "${cleanAns}"`);

        if (cleanUser === cleanAns && cleanUser !== "") {
            feedback.innerHTML = "âœ… ç­”å¯¹äº†ï¼";
            feedback.className = "feedback-correct";
            score += 10; correctCount++;
        } else {
            feedback.innerHTML = `âŒ ç­”é”™äº†ã€‚<br>ä½ çš„ç­”æ¡ˆ: ${input.value}<br>å‚è€ƒç­”æ¡ˆ: ${correctAnswer}`;
            feedback.className = "feedback-wrong";
            wrongCount++;
        }
        document.getElementById('next-btn').style.display = "inline-block";
    }

    // ä¸‡èƒ½æ¸…æ´—å­—ç¬¦ä¸²å‡½æ•°ï¼šå»ç©ºæ ¼ã€å»ç¬¦å·ã€å»å¤§å°å†™
    function normalizeString(str) {
        if (!str) return "";
        return String(str)
            .toLowerCase()
            .replace(/rm/g, "") // å»RM
            .replace(/,/g, "")  // å»é€—å·
            .replace(/\./g, "") // å»å¥å·
            .replace(/\s+/g, "") // å»æ‰€æœ‰ç©ºæ ¼
            .trim();
    }

    function nextQuestion() {
        currentQIndex++;
        if (currentQIndex < currentQuizQuestions.length) renderQuestion();
        else finishQuiz();
    }

    function quitQuiz() {
        if(confirm("ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ")) {
            document.getElementById('quiz').style.display = 'none';
            document.getElementById('chapters').style.display = 'block';
        }
    }

    function finishQuiz() {
        document.getElementById('quiz').style.display = 'none';
        document.getElementById('finish').style.display = 'block';
        const total = currentQuizQuestions.length;
        const finalPercent = Math.round((correctCount / total) * 100);
        document.getElementById('final-score').innerText = finalPercent;
        document.getElementById('final-correct').innerText = correctCount;
        document.getElementById('final-wrong').innerText = wrongCount;
    }

    function uploadScore() {
        const name = document.getElementById('student-name').value.trim();
        if(!name) return alert("è¯·è¾“å…¥åå­—");
        
        document.getElementById('submit-status').innerText = "â³ æ­£åœ¨ä¸Šä¼ ...";
        
        // æ­¤å¤„æ¨¡æ‹Ÿä¸Šä¼ ï¼Œè¯·ç¡®ä¿ SCRIPT_URL æ­£ç¡®
        // å› è·¨åŸŸé—®é¢˜ï¼Œè¿™é‡Œé€šå¸¸åªå‘é€è¯·æ±‚ä¸ç­‰å¾…è¿”å›ï¼Œæˆ–è€…ä½¿ç”¨ iframe æ–¹æ³•
        const img = new Image();
        img.src = `${SCRIPT_URL}?book=F4ACC&name=${encodeURIComponent(name)}&score=${document.getElementById('final-score').innerText}&quizId=${encodeURIComponent(currentChapterTitle)}`;
        
        setTimeout(() => {
            document.getElementById('submit-status').innerText = "âœ… æˆç»©å·²æäº¤ (å¦‚ç½‘ç»œæ­£å¸¸)";
        }, 1000);
    }
</script>

</body>
</html>
